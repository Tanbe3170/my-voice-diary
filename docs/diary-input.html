<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>日記作成 - My Voice Diary</title>
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <header>
    <h1>✏️ 日記を作成</h1>
    <button onclick="location.href='index.html'">← 戻る</button>
  </header>

  <main>
    <div class="input-methods">
      <h2>入力方法を選択</h2>

      <!-- 方法1: SuperWhisper貼り付け -->
      <div class="method">
        <h3>📱 SuperWhisper（推奨）</h3>
        <p>SuperWhisperで音声をテキスト化し、下のテキストエリアに貼り付けてください。</p>
      </div>

      <!-- 方法2: Web Speech API -->
      <div class="method">
        <h3>🎤 ブラウザ音声認識</h3>
        <button id="voice-btn" class="voice-button">
          🎤 音声入力を開始
        </button>
        <span id="voice-status"></span>
      </div>

      <!-- 方法3: 手動入力 -->
      <div class="method">
        <h3>⌨️ 手動入力</h3>
        <p>直接テキストを入力してください。</p>
      </div>
    </div>

    <div class="input-area">
      <label for="diary-text">日記の内容（口語でOK）</label>
      <textarea
        id="diary-text"
        rows="15"
        placeholder="今日は朝から...&#10;&#10;音声入力、または直接入力してください。"
      ></textarea>

      <button id="process-btn" class="primary-button">
        🤖 Claude APIで整形してGitHubに保存
      </button>

      <div id="progress" style="display:none;">
        <p>処理中...</p>
        <progress id="progress-bar" max="100" value="0"></progress>
      </div>

      <div id="result" style="display:none;"></div>
    </div>
  </main>

  <script>
    // === Web Speech API 実装 ===
    const voiceBtn = document.getElementById('voice-btn');
    const voiceStatus = document.getElementById('voice-status');
    const diaryText = document.getElementById('diary-text');

    let recognition;
    let isRecording = false;

    // ブラウザの音声認識APIをチェック
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'ja-JP';
      recognition.continuous = true;
      recognition.interimResults = true;

      voiceBtn.onclick = () => {
        if (!isRecording) {
          recognition.start();
          isRecording = true;
          voiceBtn.textContent = '⏹️ 停止';
          voiceBtn.classList.add('recording');
          voiceStatus.textContent = '🎤 録音中...';
        } else {
          recognition.stop();
          isRecording = false;
          voiceBtn.textContent = '🎤 音声入力を開始';
          voiceBtn.classList.remove('recording');
          voiceStatus.textContent = '';
        }
      };

      recognition.onresult = (event) => {
        let interimTranscript = '';
        let finalTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript + ' ';
          } else {
            interimTranscript += transcript;
          }
        }

        if (finalTranscript) {
          diaryText.value += finalTranscript;
        }
        voiceStatus.textContent = `🎤 認識中: ${interimTranscript}`;
      };

      recognition.onerror = (event) => {
        console.error('音声認識エラー:', event.error);
        voiceStatus.textContent = `❌ エラー: ${event.error}`;
        isRecording = false;
        voiceBtn.textContent = '🎤 音声入力を開始';
        voiceBtn.classList.remove('recording');
      };

      recognition.onend = () => {
        if (isRecording) {
          recognition.start(); // 継続録音
        }
      };
    } else {
      voiceBtn.disabled = true;
      voiceBtn.textContent = '❌ 音声認識非対応';
      voiceStatus.textContent = 'このブラウザは音声認識に対応していません';
    }

    // === Phase 2.5: Vercel Function連携処理 ===
    const processBtn = document.getElementById('process-btn');
    const progressDiv = document.getElementById('progress');
    const progressBar = document.getElementById('progress-bar');
    const resultDiv = document.getElementById('result');

    processBtn.onclick = async () => {
      const rawText = diaryText.value.trim();

      if (!rawText) {
        alert('日記の内容を入力してください。');
        return;
      }

      // Phase 2.5: Vercel Functionへのリクエスト用AUTH_TOKEN
      let authToken = sessionStorage.getItem('auth_token');
      if (!authToken) {
        authToken = prompt('認証トークンを入力してください:\n\n※ このトークンは管理者から提供されます。\n※ APIキーはサーバー側で安全に管理されています。');
        if (!authToken) {
          alert('認証トークンが必要です。');
          return;
        }
        sessionStorage.setItem('auth_token', authToken);
      }

      processBtn.disabled = true;
      progressDiv.style.display = 'block';
      progressBar.value = 20;

      try {
        // Phase 2.5: Vercel Functionに日記作成をリクエスト
        progressBar.value = 30;

        const response = await fetch('/api/create-diary', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Auth-Token': authToken
          },
          body: JSON.stringify({ rawText })
        });

        progressBar.value = 70;

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || '日記の作成に失敗しました。');
        }

        const result = await response.json();
        progressBar.value = 100;

        // 成功メッセージ（Vercel Functionからのレスポンスを使用）
        resultDiv.style.display = 'block';
        resultDiv.textContent = ''; // クリア

        const successDiv = document.createElement('div');
        successDiv.className = 'success';

        const successH3 = document.createElement('h3');
        successH3.textContent = '✅ 日記の保存が完了しました！';
        successDiv.appendChild(successH3);

        const titleP = document.createElement('p');
        const titleStrong = document.createElement('strong');
        titleStrong.textContent = 'タイトル: ';
        titleP.appendChild(titleStrong);
        titleP.appendChild(document.createTextNode(result.title));
        successDiv.appendChild(titleP);

        const tagsP = document.createElement('p');
        const tagsStrong = document.createElement('strong');
        tagsStrong.textContent = 'ハッシュタグ: ';
        tagsP.appendChild(tagsStrong);
        tagsP.appendChild(document.createTextNode(result.tags.join(' ')));
        successDiv.appendChild(tagsP);

        const linkP = document.createElement('p');
        const githubLink = document.createElement('a');
        githubLink.href = result.githubUrl;
        githubLink.target = '_blank';
        githubLink.textContent = '📂 GitHubで確認';
        linkP.appendChild(githubLink);
        successDiv.appendChild(linkP);

        const backBtn = document.createElement('button');
        backBtn.textContent = '📖 日記一覧に戻る';
        backBtn.onclick = () => location.href = 'index.html';
        successDiv.appendChild(backBtn);

        resultDiv.appendChild(successDiv);

        diaryText.value = ''; // フォームクリア

      } catch (error) {
        // エラーメッセージ（XSS対策: DOM構築）
        resultDiv.style.display = 'block';
        resultDiv.textContent = ''; // クリア

        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';

        const errorH3 = document.createElement('h3');
        errorH3.textContent = '❌ エラーが発生しました';
        errorDiv.appendChild(errorH3);

        const errorP = document.createElement('p');
        errorP.textContent = error.message;
        errorDiv.appendChild(errorP);

        resultDiv.appendChild(errorDiv);
      } finally {
        processBtn.disabled = false;
        progressDiv.style.display = 'none';
      }
    };

    // === セキュリティ: ページ終了時にトークンを自動削除 ===
    window.addEventListener('beforeunload', () => {
      sessionStorage.removeItem('auth_token');
    });
  </script>
</body>
</html>
