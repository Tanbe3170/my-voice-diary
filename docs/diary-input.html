<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ—¥è¨˜ä½œæˆ - My Voice Diary</title>
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <header>
    <h1>âœï¸ æ—¥è¨˜ã‚’ä½œæˆ</h1>
    <button onclick="location.href='index.html'">â† æˆ»ã‚‹</button>
  </header>

  <main>
    <div class="input-methods">
      <h2>å…¥åŠ›æ–¹æ³•ã‚’é¸æŠ</h2>

      <!-- æ–¹æ³•1: SuperWhisperè²¼ã‚Šä»˜ã‘ -->
      <div class="method">
        <h3>ğŸ“± SuperWhisperï¼ˆæ¨å¥¨ï¼‰</h3>
        <p>SuperWhisperã§éŸ³å£°ã‚’ãƒ†ã‚­ã‚¹ãƒˆåŒ–ã—ã€ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
      </div>

      <!-- æ–¹æ³•2: Web Speech API -->
      <div class="method">
        <h3>ğŸ¤ ãƒ–ãƒ©ã‚¦ã‚¶éŸ³å£°èªè­˜</h3>
        <button id="voice-btn" class="voice-button">
          ğŸ¤ éŸ³å£°å…¥åŠ›ã‚’é–‹å§‹
        </button>
        <span id="voice-status"></span>
      </div>

      <!-- æ–¹æ³•3: æ‰‹å‹•å…¥åŠ› -->
      <div class="method">
        <h3>âŒ¨ï¸ æ‰‹å‹•å…¥åŠ›</h3>
        <p>ç›´æ¥ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
      </div>
    </div>

    <div class="input-area">
      <label for="diary-text">æ—¥è¨˜ã®å†…å®¹ï¼ˆå£èªã§OKï¼‰</label>
      <textarea
        id="diary-text"
        rows="15"
        placeholder="ä»Šæ—¥ã¯æœã‹ã‚‰...&#10;&#10;éŸ³å£°å…¥åŠ›ã€ã¾ãŸã¯ç›´æ¥å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"
      ></textarea>

      <button id="process-btn" class="primary-button">
        ğŸ¤– Claude APIã§æ•´å½¢ã—ã¦GitHubã«ä¿å­˜
      </button>

      <div id="progress" style="display:none;">
        <p>å‡¦ç†ä¸­...</p>
        <progress id="progress-bar" max="100" value="0"></progress>
      </div>

      <div id="result" style="display:none;"></div>
    </div>
  </main>

  <script>
    // === Web Speech API å®Ÿè£… ===
    const voiceBtn = document.getElementById('voice-btn');
    const voiceStatus = document.getElementById('voice-status');
    const diaryText = document.getElementById('diary-text');

    let recognition;
    let isRecording = false;

    // ãƒ–ãƒ©ã‚¦ã‚¶ã®éŸ³å£°èªè­˜APIã‚’ãƒã‚§ãƒƒã‚¯
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'ja-JP';
      recognition.continuous = true;
      recognition.interimResults = true;

      voiceBtn.onclick = () => {
        if (!isRecording) {
          recognition.start();
          isRecording = true;
          voiceBtn.textContent = 'â¹ï¸ åœæ­¢';
          voiceBtn.classList.add('recording');
          voiceStatus.textContent = 'ğŸ¤ éŒ²éŸ³ä¸­...';
        } else {
          recognition.stop();
          isRecording = false;
          voiceBtn.textContent = 'ğŸ¤ éŸ³å£°å…¥åŠ›ã‚’é–‹å§‹';
          voiceBtn.classList.remove('recording');
          voiceStatus.textContent = '';
        }
      };

      recognition.onresult = (event) => {
        let interimTranscript = '';
        let finalTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript + ' ';
          } else {
            interimTranscript += transcript;
          }
        }

        if (finalTranscript) {
          diaryText.value += finalTranscript;
        }
        voiceStatus.textContent = `ğŸ¤ èªè­˜ä¸­: ${interimTranscript}`;
      };

      recognition.onerror = (event) => {
        console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
        voiceStatus.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${event.error}`;
        isRecording = false;
        voiceBtn.textContent = 'ğŸ¤ éŸ³å£°å…¥åŠ›ã‚’é–‹å§‹';
        voiceBtn.classList.remove('recording');
      };

      recognition.onend = () => {
        if (isRecording) {
          recognition.start(); // ç¶™ç¶šéŒ²éŸ³
        }
      };
    } else {
      voiceBtn.disabled = true;
      voiceBtn.textContent = 'âŒ éŸ³å£°èªè­˜éå¯¾å¿œ';
      voiceStatus.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“';
    }

    // === Claude API + GitHub API é€£æºå‡¦ç† ===
    const processBtn = document.getElementById('process-btn');
    const progressDiv = document.getElementById('progress');
    const progressBar = document.getElementById('progress-bar');
    const resultDiv = document.getElementById('result');

    processBtn.onclick = async () => {
      const rawText = diaryText.value.trim();

      if (!rawText) {
        alert('æ—¥è¨˜ã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      // GitHub Personal Access Tokenï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…¥åŠ›ã•ã›ã‚‹ or LocalStorageã‹ã‚‰å–å¾—ï¼‰
      let githubToken = localStorage.getItem('github_token');
      if (!githubToken) {
        githubToken = prompt('GitHub Personal Access Token ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:\n\n(åˆå›ã®ã¿ã€‚LocalStorageã«ä¿å­˜ã•ã‚Œã¾ã™)');
        if (!githubToken) {
          alert('ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ã§ã™ã€‚');
          return;
        }
        localStorage.setItem('github_token', githubToken);
      }

      // Claude API Keyï¼ˆåŒæ§˜ï¼‰
      let claudeApiKey = localStorage.getItem('claude_api_key');
      if (!claudeApiKey) {
        claudeApiKey = prompt('Claude API Key ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:\n\n(åˆå›ã®ã¿ã€‚LocalStorageã«ä¿å­˜ã•ã‚Œã¾ã™)');
        if (!claudeApiKey) {
          alert('APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚');
          return;
        }
        localStorage.setItem('claude_api_key', claudeApiKey);
      }

      processBtn.disabled = true;
      progressDiv.style.display = 'block';
      progressBar.value = 20;

      try {
        // ã‚¹ãƒ†ãƒƒãƒ—1: Claude APIã§æ—¥è¨˜æ•´å½¢
        progressBar.value = 30;
        const diaryData = await summarizeDiary(rawText, claudeApiKey);

        progressBar.value = 60;

        // ã‚¹ãƒ†ãƒƒãƒ—2: Markdownãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
        const markdown = generateMarkdown(diaryData);

        progressBar.value = 80;

        // ã‚¹ãƒ†ãƒƒãƒ—3: GitHub APIã§push
        const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
        const year = today.split('-')[0];
        const month = today.split('-')[1];
        const filePath = `diaries/${year}/${month}/${today}.md`;

        await pushToGitHub(githubToken, filePath, markdown, diaryData.title);

        progressBar.value = 100;

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
          <div class="success">
            <h3>âœ… æ—¥è¨˜ã®ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸï¼</h3>
            <p><strong>ã‚¿ã‚¤ãƒˆãƒ«:</strong> ${diaryData.title}</p>
            <p><strong>ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°:</strong> ${diaryData.tags.join(' ')}</p>
            <p><a href="https://github.com/Tanbe3170/my-voice-diary/blob/main/${filePath}" target="_blank">
              ğŸ“‚ GitHubã§ç¢ºèª
            </a></p>
            <button onclick="location.href='index.html'">ğŸ“– æ—¥è¨˜ä¸€è¦§ã«æˆ»ã‚‹</button>
          </div>
        `;

        diaryText.value = ''; // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢

      } catch (error) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
          <div class="error">
            <h3>âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3>
            <p>${error.message}</p>
          </div>
        `;
      } finally {
        processBtn.disabled = false;
        progressDiv.style.display = 'none';
      }
    };

    // === Claude API å‘¼ã³å‡ºã—é–¢æ•° ===
    async function summarizeDiary(rawText, apiKey) {
      const today = new Date().toLocaleDateString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      }).replace(/\//g, 'å¹´').replace(/å¹´0?/, 'å¹´').replace(/æœˆ0?/, 'æœˆ') + 'æ—¥';

      const prompt = `ã‚ãªãŸã¯æ—¥è¨˜åŸ·ç­†ã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®éŸ³å£°å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå£èªï¼‰ã‚’ã€æ–‡èªã®æ—¥è¨˜å½¢å¼ã«æ•´å½¢ã—ã¦ãã ã•ã„ã€‚

ã€éŸ³å£°å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã€‘
${rawText}

ã€å‡ºåŠ›å½¢å¼ã€‘
ä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚JSONã®å‰å¾Œã«èª¬æ˜æ–‡ã¯ä¸è¦ã§ã™ã€‚

\`\`\`json
{
  "date": "${today}",
  "title": "ãã®æ—¥ã®å‡ºæ¥äº‹ã‚’è¦ç´„ã—ãŸé­…åŠ›çš„ãªã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ15æ–‡å­—ä»¥å†…ï¼‰",
  "summary": "3è¡Œã‚µãƒãƒªãƒ¼ï¼ˆ1è¡Œ30æ–‡å­—ç¨‹åº¦ã€æ”¹è¡Œã§åŒºåˆ‡ã‚‹ï¼‰",
  "body": "è©³ç´°ãªæ—¥è¨˜æœ¬æ–‡ï¼ˆæ®µè½åˆ†ã‘ã‚ã‚Šã€æ–‡èªä½“ã§æ•´ã£ãŸæ–‡ç« ï¼‰",
  "tags": ["é–¢é€£ã™ã‚‹ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°", "5å€‹ç¨‹åº¦"],
  "image_prompt": "ã“ã®æ—¥è¨˜ã‹ã‚‰1æšã®ç”»åƒã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®è‹±èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆDALL-Eç”¨ã€è©³ç´°ã«ï¼‰"
}
\`\`\`

ã€æ•´å½¢ã®ãƒ«ãƒ¼ãƒ«ã€‘
1. å£èªï¼ˆã€Œã€œã§ã—ãŸã€ã€Œã€œãªã‚“ã ã‘ã©ã€ï¼‰â†’ æ–‡èªï¼ˆã€Œã€œã ã£ãŸã€ã€Œã€œã ãŒã€ï¼‰
2. ã‚¿ã‚¤ãƒˆãƒ«ã¯èª­è€…ã®èˆˆå‘³ã‚’å¼•ãå·¥å¤«ã‚’ã™ã‚‹
3. ã‚µãƒãƒªãƒ¼ã¯3è¡Œã§è¦ç‚¹ã‚’ã¾ã¨ã‚ã‚‹
4. æœ¬æ–‡ã¯é©åº¦ã«æ®µè½åˆ†ã‘ã—ã€èª­ã¿ã‚„ã™ãã™ã‚‹
5. ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã¯InstagramæŠ•ç¨¿ã‚’æƒ³å®šï¼ˆ#æ—¥è¨˜ #ä»Šæ—¥ã®å‡ºæ¥äº‹ ãªã©ï¼‰
6. ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯æƒ…æ™¯ãŒæµ®ã‹ã¶ã‚ˆã†ãªå…·ä½“çš„ãªè‹±èªã§è¨˜è¿°

ãã‚Œã§ã¯ã€éŸ³å£°å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚’æ—¥è¨˜ã«æ•´å½¢ã—ã¦ãã ã•ã„ã€‚`;

      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 2000,
          messages: [{ role: 'user', content: prompt }]
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(`Claude API ã‚¨ãƒ©ãƒ¼: ${error.error.message}`);
      }

      const data = await response.json();
      const responseText = data.content[0].text;

      // JSONæŠ½å‡ºï¼ˆ```json ... ``` ã¾ãŸã¯ {...} ã‚’æŠ½å‡ºï¼‰
      const jsonMatch = responseText.match(/```json\s*(\{.*?\})\s*```/s) ||
                        responseText.match(/(\{.*\})/s);

      if (!jsonMatch) {
        throw new Error('Claude APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰JSONã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ');
      }

      return JSON.parse(jsonMatch[1]);
    }

    // === Markdownç”Ÿæˆé–¢æ•° ===
    function generateMarkdown(diaryData) {
      const today = new Date().toISOString().split('T')[0];
      const tags = diaryData.tags.map(tag => tag.startsWith('#') ? tag : '#' + tag);

      return `---
title: "${diaryData.title}"
date: ${today}
tags: [${tags.join(', ')}]
image_prompt: "${diaryData.image_prompt}"
---

# ${diaryData.title}

## ğŸ“… ${today}

### ğŸ“– ã‚µãƒãƒªãƒ¼

${diaryData.summary}

---

${diaryData.body}

---

**Tags:** ${tags.join(' ')}
`;
    }

    // === GitHub API Pushé–¢æ•° ===
    async function pushToGitHub(token, filePath, content, commitMessage) {
      const owner = 'Tanbe3170';
      const repo = 'my-voice-diary';
      const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`;

      // æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®SHAå–å¾—ï¼ˆä¸Šæ›¸ãæ™‚ã«å¿…è¦ï¼‰
      let sha;
      try {
        const getResponse = await fetch(apiUrl, {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        if (getResponse.ok) {
          const data = await getResponse.json();
          sha = data.sha;
        }
      } catch (e) {
        // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯shaä¸è¦
      }

      // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
      const contentBase64 = btoa(unescape(encodeURIComponent(content)));

      const body = {
        message: `diary: ${new Date().toISOString().split('T')[0]} - ${commitMessage}`,
        content: contentBase64,
        branch: 'main'
      };

      if (sha) {
        body.sha = sha; // æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ä¸Šæ›¸ã
      }

      const response = await fetch(apiUrl, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(`GitHub API ã‚¨ãƒ©ãƒ¼: ${error.message}`);
      }

      return await response.json();
    }
  </script>
</body>
</html>