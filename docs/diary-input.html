<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>日記作成 - My Voice Diary</title>
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <header>
    <h1>✏️ 日記を作成</h1>
    <button onclick="location.href='index.html'">← 戻る</button>
  </header>

  <main>
    <div class="input-methods">
      <h2>入力方法を選択</h2>

      <!-- 方法1: SuperWhisper貼り付け -->
      <div class="method">
        <h3>📱 SuperWhisper（推奨）</h3>
        <p>SuperWhisperで音声をテキスト化し、下のテキストエリアに貼り付けてください。</p>
      </div>

      <!-- 方法2: Web Speech API -->
      <div class="method">
        <h3>🎤 ブラウザ音声認識</h3>
        <button id="voice-btn" class="voice-button">
          🎤 音声入力を開始
        </button>
        <span id="voice-status"></span>
      </div>

      <!-- 方法3: 手動入力 -->
      <div class="method">
        <h3>⌨️ 手動入力</h3>
        <p>直接テキストを入力してください。</p>
      </div>
    </div>

    <div class="input-area">
      <label for="diary-text">日記の内容（口語でOK）</label>
      <textarea
        id="diary-text"
        rows="15"
        placeholder="今日は朝から...&#10;&#10;音声入力、または直接入力してください。"
      ></textarea>

      <button id="process-btn" class="primary-button">
        🤖 Claude APIで整形してGitHubに保存
      </button>

      <div id="progress" style="display:none;">
        <p>処理中...</p>
        <progress id="progress-bar" max="100" value="0"></progress>
      </div>

      <div id="result" style="display:none;"></div>
    </div>
  </main>

  <script>
    // === Web Speech API 実装 ===
    const voiceBtn = document.getElementById('voice-btn');
    const voiceStatus = document.getElementById('voice-status');
    const diaryText = document.getElementById('diary-text');

    let recognition;
    let isRecording = false;

    // ブラウザの音声認識APIをチェック
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'ja-JP';
      recognition.continuous = true;
      recognition.interimResults = true;

      voiceBtn.onclick = () => {
        if (!isRecording) {
          recognition.start();
          isRecording = true;
          voiceBtn.textContent = '⏹️ 停止';
          voiceBtn.classList.add('recording');
          voiceStatus.textContent = '🎤 録音中...';
        } else {
          recognition.stop();
          isRecording = false;
          voiceBtn.textContent = '🎤 音声入力を開始';
          voiceBtn.classList.remove('recording');
          voiceStatus.textContent = '';
        }
      };

      recognition.onresult = (event) => {
        let interimTranscript = '';
        let finalTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript + ' ';
          } else {
            interimTranscript += transcript;
          }
        }

        if (finalTranscript) {
          diaryText.value += finalTranscript;
        }
        voiceStatus.textContent = `🎤 認識中: ${interimTranscript}`;
      };

      recognition.onerror = (event) => {
        console.error('音声認識エラー:', event.error);
        voiceStatus.textContent = `❌ エラー: ${event.error}`;
        isRecording = false;
        voiceBtn.textContent = '🎤 音声入力を開始';
        voiceBtn.classList.remove('recording');
      };

      recognition.onend = () => {
        if (isRecording) {
          recognition.start(); // 継続録音
        }
      };
    } else {
      voiceBtn.disabled = true;
      voiceBtn.textContent = '❌ 音声認識非対応';
      voiceStatus.textContent = 'このブラウザは音声認識に対応していません';
    }

    // === Phase 2.5: Vercel Function連携処理 ===
    const processBtn = document.getElementById('process-btn');
    const progressDiv = document.getElementById('progress');
    const progressBar = document.getElementById('progress-bar');
    const resultDiv = document.getElementById('result');

    processBtn.onclick = async () => {
      const rawText = diaryText.value.trim();

      if (!rawText) {
        alert('日記の内容を入力してください。');
        return;
      }

      // 認証トークン（JWT）の取得
      let authToken = sessionStorage.getItem('auth_token');
      if (!authToken) {
        authToken = prompt('認証トークン（JWT）を入力してください:\n\n※ このトークンは管理者から提供されます。\n※ トークンには有効期限があります。期限切れの場合は再取得してください。');
        if (!authToken) {
          alert('認証トークンが必要です。');
          return;
        }
        sessionStorage.setItem('auth_token', authToken);
      }

      processBtn.disabled = true;
      progressDiv.style.display = 'block';
      progressBar.value = 20;

      try {
        // Phase 2.5: Vercel Functionに日記作成をリクエスト
        progressBar.value = 30;

        const response = await fetch('/api/create-diary', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Auth-Token': authToken
          },
          body: JSON.stringify({ rawText })
        });

        progressBar.value = 70;

        if (!response.ok) {
          const errorData = await response.json();
          // 401: トークン期限切れ→sessionStorageクリア→再入力を促す
          if (response.status === 401) {
            sessionStorage.removeItem('auth_token');
          }
          throw new Error(errorData.error || '日記の作成に失敗しました。');
        }

        const result = await response.json();
        progressBar.value = 100;

        // 成功メッセージ（Vercel Functionからのレスポンスを使用）
        resultDiv.style.display = 'block';
        resultDiv.textContent = ''; // クリア

        const successDiv = document.createElement('div');
        successDiv.className = 'success';

        const successH3 = document.createElement('h3');
        successH3.textContent = '✅ 日記の保存が完了しました！';
        successDiv.appendChild(successH3);

        const titleP = document.createElement('p');
        const titleStrong = document.createElement('strong');
        titleStrong.textContent = 'タイトル: ';
        titleP.appendChild(titleStrong);
        titleP.appendChild(document.createTextNode(result.title));
        successDiv.appendChild(titleP);

        const tagsP = document.createElement('p');
        const tagsStrong = document.createElement('strong');
        tagsStrong.textContent = 'ハッシュタグ: ';
        tagsP.appendChild(tagsStrong);
        tagsP.appendChild(document.createTextNode(result.tags.join(' ')));
        successDiv.appendChild(tagsP);

        const linkP = document.createElement('p');
        const githubLink = document.createElement('a');
        githubLink.href = result.githubUrl;
        githubLink.target = '_blank';
        githubLink.rel = 'noopener noreferrer';
        githubLink.textContent = '📂 GitHubで確認';
        linkP.appendChild(githubLink);
        successDiv.appendChild(linkP);

        // Phase 4: 画像生成ボタン（imageTokenがある場合のみ表示）
        if (result.imageToken && result.date) {
          const imageSection = document.createElement('div');
          imageSection.className = 'image-generate-section';

          const costNotice = document.createElement('p');
          costNotice.className = 'cost-notice';
          costNotice.textContent = 'DALL-E 3で日記のイメージ画像を生成できます（$0.04/枚）';
          imageSection.appendChild(costNotice);

          const imageBtn = document.createElement('button');
          imageBtn.className = 'image-generate-btn';
          imageBtn.textContent = '🎨 画像を生成する';
          imageBtn.onclick = async () => {
            imageBtn.disabled = true;
            imageBtn.textContent = '🎨 画像を生成中...';

            try {
              const imgResponse = await fetch('/api/generate-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  date: result.date,
                  imageToken: result.imageToken
                })
              });

              if (!imgResponse.ok) {
                const imgError = await imgResponse.json();
                throw new Error(imgError.error || '画像の生成に失敗しました。');
              }

              const imgResult = await imgResponse.json();

              // 画像プレビュー表示（XSS対策: DOM構築パターン）
              const previewDiv = document.createElement('div');
              previewDiv.className = 'image-preview';

              const previewH4 = document.createElement('h4');
              previewH4.textContent = '生成された画像';
              previewDiv.appendChild(previewH4);

              const previewImg = document.createElement('img');
              // Base64があればdata URLで即時表示（CDNキャッシュ回避）
              previewImg.src = imgResult.imageBase64
                ? `data:image/png;base64,${imgResult.imageBase64}`
                : imgResult.imageUrl;
              previewImg.alt = '日記のイメージ画像';
              previewDiv.appendChild(previewImg);

              const imgLinkP = document.createElement('p');
              const imgLink = document.createElement('a');
              imgLink.href = imgResult.githubUrl;
              imgLink.target = '_blank';
              imgLink.rel = 'noopener noreferrer';
              imgLink.textContent = '📂 GitHubで画像を確認';
              imgLinkP.appendChild(imgLink);
              previewDiv.appendChild(imgLinkP);

              imageSection.replaceChild(previewDiv, imageBtn);
              costNotice.textContent = '画像が正常に生成・保存されました！';

              // Phase 5: Instagram投稿セクション
              const igSection = document.createElement('div');
              igSection.className = 'instagram-section';

              const igH4 = document.createElement('h4');
              igH4.textContent = 'Instagramに投稿';
              igSection.appendChild(igH4);

              const igLabel = document.createElement('label');
              igLabel.setAttribute('for', 'ig-caption');
              igLabel.textContent = 'キャプション（編集可能）';
              igSection.appendChild(igLabel);

              const igCaption = document.createElement('textarea');
              igCaption.id = 'ig-caption';
              igCaption.rows = 6;
              igCaption.maxLength = 2200;
              // キャプション自動生成
              const autoCaption = [
                result.title || '',
                '',
                (result.tags || []).map(t => t.startsWith('#') ? t : '#' + t).join(' '),
                '',
                '#日記 #VoiceDiary #AI日記'
              ].join('\n');
              igCaption.value = autoCaption;
              igSection.appendChild(igCaption);

              const igCounter = document.createElement('span');
              igCounter.className = 'ig-char-count';
              igCounter.textContent = `${igCaption.value.length} / 2200`;
              igSection.appendChild(igCounter);

              igCaption.addEventListener('input', () => {
                const over = igCaption.value.length > 2200;
                igCounter.textContent = `${igCaption.value.length} / 2200`;
                igCounter.classList.toggle('over-limit', over);
                igPostBtn.disabled = over;
              });

              const igPostBtn = document.createElement('button');
              igPostBtn.className = 'ig-post-btn';
              igPostBtn.textContent = '📸 Instagramに投稿';
              igPostBtn.onclick = async () => {
                if (!confirm('この内容でInstagramに投稿しますか？')) return;

                igPostBtn.disabled = true;
                igPostBtn.textContent = '📸 投稿中...';

                try {
                  const igResponse = await fetch('/api/post-instagram', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'X-Auth-Token': authToken
                    },
                    body: JSON.stringify({
                      date: result.date,
                      caption: igCaption.value || undefined
                    })
                  });

                  const igData = await igResponse.json();

                  if (!igResponse.ok) {
                    throw new Error(igData.error || 'Instagram投稿に失敗しました。');
                  }

                  // 成功表示
                  const igResultDiv = document.createElement('div');
                  igResultDiv.className = 'ig-success';
                  const igMsg = document.createElement('p');
                  if (igData.alreadyPosted) {
                    igMsg.textContent = '✅ この日記は既にInstagramに投稿済みです。';
                  } else {
                    igMsg.textContent = '✅ Instagramへの投稿が完了しました！';
                  }
                  igResultDiv.appendChild(igMsg);

                  const igIdP = document.createElement('p');
                  igIdP.textContent = `投稿ID: ${igData.postId}`;
                  igResultDiv.appendChild(igIdP);

                  // ボタンとキャプション入力を結果表示に置換
                  igPostBtn.style.display = 'none';
                  igCaption.disabled = true;
                  igSection.appendChild(igResultDiv);

                } catch (igErr) {
                  igPostBtn.disabled = false;
                  igPostBtn.textContent = '📸 Instagramに投稿';

                  // 401: トークン期限切れの可能性
                  const igErrP = document.createElement('p');
                  igErrP.className = 'ig-error';
                  igErrP.textContent = igErr.message;
                  igSection.appendChild(igErrP);
                }
              };
              igSection.appendChild(igPostBtn);

              imageSection.appendChild(igSection);

              // Phase 5.5: Bluesky投稿セクション
              const bsSection = document.createElement('div');
              bsSection.className = 'bluesky-section';

              const bsH4 = document.createElement('h4');
              bsH4.textContent = 'Blueskyに投稿';
              bsSection.appendChild(bsH4);

              const bsLabel = document.createElement('label');
              bsLabel.setAttribute('for', 'bs-text');
              bsLabel.textContent = 'テキスト（編集可能）';
              bsSection.appendChild(bsLabel);

              const bsText = document.createElement('textarea');
              bsText.id = 'bs-text';
              bsText.rows = 4;
              // 自動生成テキスト
              const bsAutoText = [
                result.title || '',
                '',
                (result.tags || []).map(t => t.startsWith('#') ? t : '#' + t).join(' ')
              ].join('\n');
              bsText.value = bsAutoText;
              bsSection.appendChild(bsText);

              const bsCounter = document.createElement('span');
              bsCounter.className = 'bs-grapheme-count';
              const countGraphemes = (str) => {
                const segmenter = new Intl.Segmenter('ja', { granularity: 'grapheme' });
                return [...segmenter.segment(str)].length;
              };
              const bsGraphemes = countGraphemes(bsText.value);
              bsCounter.textContent = `${bsGraphemes} / 300 graphemes`;
              if (bsGraphemes > 300) bsCounter.classList.add('over-limit');
              bsSection.appendChild(bsCounter);

              bsText.addEventListener('input', () => {
                const g = countGraphemes(bsText.value);
                const over = g > 300;
                bsCounter.textContent = `${g} / 300 graphemes`;
                bsCounter.classList.toggle('over-limit', over);
                bsPostBtn.disabled = over;
              });

              const bsPostBtn = document.createElement('button');
              bsPostBtn.className = 'bs-post-btn';
              bsPostBtn.textContent = '\ud83e\udd8b Blueskyに投稿';
              if (bsGraphemes > 300) bsPostBtn.disabled = true;
              bsPostBtn.onclick = async () => {
                if (!confirm('この内容でBlueskyに投稿しますか？')) return;

                bsPostBtn.disabled = true;
                bsPostBtn.textContent = '\ud83e\udd8b 投稿中...';

                try {
                  const bsResponse = await fetch('/api/post-bluesky', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'X-Auth-Token': authToken
                    },
                    body: JSON.stringify({
                      date: result.date,
                      text: bsText.value || undefined
                    })
                  });

                  const bsData = await bsResponse.json();

                  if (!bsResponse.ok) {
                    throw new Error(bsData.error || 'Bluesky投稿に失敗しました。');
                  }

                  const bsResultDiv = document.createElement('div');
                  bsResultDiv.className = 'bs-success';
                  const bsMsg = document.createElement('p');
                  if (bsData.alreadyPosted) {
                    bsMsg.textContent = '\u2705 この日記は既にBlueskyに投稿済みです。';
                  } else {
                    bsMsg.textContent = '\u2705 Blueskyへの投稿が完了しました！';
                  }
                  bsResultDiv.appendChild(bsMsg);

                  bsPostBtn.style.display = 'none';
                  bsText.disabled = true;
                  bsSection.appendChild(bsResultDiv);

                } catch (bsErr) {
                  bsPostBtn.disabled = false;
                  bsPostBtn.textContent = '\ud83e\udd8b Blueskyに投稿';

                  const bsErrP = document.createElement('p');
                  bsErrP.className = 'bs-error';
                  bsErrP.textContent = bsErr.message;
                  bsSection.appendChild(bsErrP);
                }
              };
              bsSection.appendChild(bsPostBtn);

              imageSection.appendChild(bsSection);

              // Phase 5.5: Threads投稿セクション
              const thSection = document.createElement('div');
              thSection.className = 'threads-section';

              const thH4 = document.createElement('h4');
              thH4.textContent = 'Threadsに投稿';
              thSection.appendChild(thH4);

              const thLabel = document.createElement('label');
              thLabel.setAttribute('for', 'th-text');
              thLabel.textContent = 'テキスト（編集可能）';
              thSection.appendChild(thLabel);

              const thText = document.createElement('textarea');
              thText.id = 'th-text';
              thText.rows = 4;
              thText.maxLength = 500;
              // 自動生成テキスト
              const thAutoText = [
                result.title || '',
                '',
                (result.tags || []).map(t => t.startsWith('#') ? t : '#' + t).join(' ')
              ].join('\n');
              thText.value = thAutoText;
              thSection.appendChild(thText);

              const thCounter = document.createElement('span');
              thCounter.className = 'th-char-count';
              thCounter.textContent = `${thText.value.length} / 500`;
              if (thText.value.length > 500) thCounter.classList.add('over-limit');
              thSection.appendChild(thCounter);

              thText.addEventListener('input', () => {
                const over = thText.value.length > 500;
                thCounter.textContent = `${thText.value.length} / 500`;
                thCounter.classList.toggle('over-limit', over);
                thPostBtn.disabled = over;
              });

              const thPostBtn = document.createElement('button');
              thPostBtn.className = 'th-post-btn';
              thPostBtn.textContent = '\ud83e\uddf5 Threadsに投稿';
              if (thText.value.length > 500) thPostBtn.disabled = true;
              thPostBtn.onclick = async () => {
                if (!confirm('この内容でThreadsに投稿しますか？')) return;

                thPostBtn.disabled = true;
                thPostBtn.textContent = '\ud83e\uddf5 投稿中...';

                try {
                  const thResponse = await fetch('/api/post-threads', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'X-Auth-Token': authToken
                    },
                    body: JSON.stringify({
                      date: result.date,
                      text: thText.value || undefined
                    })
                  });

                  const thData = await thResponse.json();

                  if (!thResponse.ok) {
                    throw new Error(thData.error || 'Threads投稿に失敗しました。');
                  }

                  const thResultDiv = document.createElement('div');
                  thResultDiv.className = 'th-success';
                  const thMsg = document.createElement('p');
                  if (thData.alreadyPosted) {
                    thMsg.textContent = '\u2705 この日記は既にThreadsに投稿済みです。';
                  } else {
                    thMsg.textContent = '\u2705 Threadsへの投稿が完了しました！';
                  }
                  thResultDiv.appendChild(thMsg);

                  const thIdP = document.createElement('p');
                  thIdP.textContent = `投稿ID: ${thData.postId}`;
                  thResultDiv.appendChild(thIdP);

                  thPostBtn.style.display = 'none';
                  thText.disabled = true;
                  thSection.appendChild(thResultDiv);

                } catch (thErr) {
                  thPostBtn.disabled = false;
                  thPostBtn.textContent = '\ud83e\uddf5 Threadsに投稿';

                  const thErrP = document.createElement('p');
                  thErrP.className = 'th-error';
                  thErrP.textContent = thErr.message;
                  thSection.appendChild(thErrP);
                }
              };
              thSection.appendChild(thPostBtn);

              imageSection.appendChild(thSection);

            } catch (imgError) {
              imageBtn.disabled = false;
              imageBtn.textContent = '🎨 画像を生成する';

              const imgErrorP = document.createElement('p');
              imgErrorP.className = 'image-error';
              imgErrorP.textContent = imgError.message;
              imageSection.appendChild(imgErrorP);
            }
          };
          imageSection.appendChild(imageBtn);
          successDiv.appendChild(imageSection);
        }

        const backBtn = document.createElement('button');
        backBtn.textContent = '📖 日記一覧に戻る';
        backBtn.onclick = () => location.href = 'index.html';
        successDiv.appendChild(backBtn);

        resultDiv.appendChild(successDiv);

        diaryText.value = ''; // フォームクリア

      } catch (error) {
        // エラーメッセージ（XSS対策: DOM構築）
        resultDiv.style.display = 'block';
        resultDiv.textContent = ''; // クリア

        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';

        const errorH3 = document.createElement('h3');
        errorH3.textContent = '❌ エラーが発生しました';
        errorDiv.appendChild(errorH3);

        const errorP = document.createElement('p');
        errorP.textContent = error.message;
        errorDiv.appendChild(errorP);

        resultDiv.appendChild(errorDiv);
      } finally {
        processBtn.disabled = false;
        progressDiv.style.display = 'none';
      }
    };

    // === セキュリティ: ページ終了時にトークンを自動削除 ===
    window.addEventListener('beforeunload', () => {
      sessionStorage.removeItem('auth_token');
    });
  </script>
</body>
</html>
